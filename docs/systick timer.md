# Системный таймер
Системный таймер работает в режиме сна микроконтролера. Он непрерывно
тактируется и выдает прерывания compare.
Предназначен для создания событий через заданный промежуток времени.
Используется такими задачами как светодиодная индикация, измерение параметров
с датчиков. Системному таймеру не нужна высокая точность либо гаранитрованое
время отклика, он должен позволять устанавливать множежстов событий на 
отложенное время исполнения.
В STM32L151 для этих целей подходят таймеры TIM9,10,11.
В документации RM0038 глава 6.2.15 Clock-independent system clock sources for
TIM9/TIM10/TIM11 сказано о том что есть возможность на вход таймера подать
сигнал LSE. Только частота шины APB должна быть минимум в два раза выше
частоты LSE. Мы выбрали APB = 127 кГц.
Таймеры считают от 1 до 65536 и могут быть изменены на лету.
Таймеры генерируют прерывания переполнения и сравнения.
Таймеры автоматически перезагружаются и считают вверх.

Один квант времени составит 8/32768 = 244,140625 мкс
Максимальное время счета 65535/32768 = 15,999755859 сек.

Предлагается в качестве основной единици измерения в системе использовать квант
времени равный 8/32768 (TimeQuant) и вся работа устройства строится относительно
этой единицы измерения. Можно добавить макрос перевода мс в кванты.
Таймер имеет свой список временых задач, исходя из него он расчитывает время
которое нужно установить в счетчик сравнения. Если задач нет, то устанавливает 
максимальное время. В таймер загружается событие время выполнения которой
наступит быстрее всего. Время расчитывается из поля fireTime.
Установка таймера должна происходить в двух случаях: при добавлении нового
события и при срабатывании прерывания. При добавлении события в очередь
запускается алгоритм анализа, который переустановит таймер. Возможно, придется
отменить ранее установленную задачу и разместить новую.
При наступлении прерывания, задача удаляется из очереди (deactivated=1),
размещается новая задача в таймер (если они есть) и генерируется event в 
системе. Далее выход из прерывания.

Алгоритм вставки задачи в список timeTasksList_t проверяет наличие свободных
мест (items<MAX_TIME_TASKS), ищет свободную запись deactivated=1 и помещает
туда задачу. 
Модуль имеет глобальное данное  ptr_t loadedTask которое указывает какая
задача сейчас загружена в таймер. loadedTask == 0xFF нет задач.
Глобальное данное timeQuant_t lastTimeFired время когда таймер сгенерировал
прерывание.

Использует:
 * events.h

Структура данных uint16_t timeQuant_t
Единица измерений времени

Тип данных uint8_t ptr_t
Указатель на индекс массива

Структура данных timeTask_t
 * event_t event 
 * timeQuant_t fireTime - время когда сработает таймер
 * uint8_t deactivated - если = 1 задача снята с очереди 
fireTime = qtime+current timer count, if now=1
fireTime = qtime+lastTimeFired, if now=0

Список timeTasksList_t
 * timeTask_t task[MAX_TIME_TASKS]
 * ptr_t items - количество элементов в списке
Списко временных задач


Интерфейс системного таймера предоставляет функционал:
* void wkuTimerAddEvent(event_t event, timeQuant_t qtime, uint8_t now)
  Добовляет событие на отложенное исполнение чере qtime квантов начиная
  от текущего момента времени (now = 1) или от предыдущего времени срабатывания
  таймера.

* float wkuTimeQuantToSec(timeQuant_t qtime) 
  Возвращает время в секундах между квантами
