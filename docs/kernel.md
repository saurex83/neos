
# Микро-ОС Neos (Neocore OS)  

ОС предназначена для управления асинхронными задачами в модулях беспроводной
связи сенсорной сети и обеспечения эффективного энергопотребления.          
Ядро ОС использует абстрактный аппаратный уровень HAL микроконтролера.       
HAL инициализируется отдельно, до запуска планировщика. Есть ряд функций,    
используемые ядром и имеющие заглушки (светодиоды, uart)                     
Управление системным таймером, режимом ожидания занимается ядро.                                                                             
Модули могут напрямую использовать аппаратуру МК, к примеру обработчики      
прерываний  

# Устройство операционной сисетемы NEOS

Операционная система состоит из менеджера событий, диспетчера задач, аппаратного уровня абстракций (HAL). 

## Порядок загрузки ядра
0. Блокировка глобальных прерываний
1. Перевод тактового генератора MCU на HSI 16 Мгц
2. Запуск часового кварца
3. Установка системного таймера на интервал 1мс
4. Запуск таймера пробуждения MCU из глубокого сна
5. Инициализация подсистемы HAL
6. Инициализация модуля событий
7. Постановка первого события 'booted'
8. Разрешение прерываний
9. Запуск цикла диспечера задач

## Подсистема HAL
Подсистема состоит из раздельных модулей с именем HAL_xxx.c (HAL_ADC.c)  и заголовочным файлом HAL_xxx.h (HAL_ADC.h). Каждый модуль выполняеть только свойственный ему функционал, не нужно создавать универсальные модули. Модуль 
может использовать другии модули и поэтому важен порядок инициализации.
Инициализация модулей происходит в файле hal.c, он же определяет ее порядок.

### hal_ret hal_init(void)

## Модуль событий
Модуль представляет собой простую очередь FIFO с блокировкой повторного размещения элемента. Настройки модуля в файле kernel_configuration.h.
Модуль производит постановку события в очередь, извлечение событий из очереди.
При попытке поставить в очередь событие уже установленное, функция успешно завершит свою работу. При превышении максимальной глубины очереди, ядро перейдет в режим kernel panic.
Функции модуля:

### kcodes core_push_event(k_event event)
Возвращает k_ok. 

### kcodes core_pop_event(k_event *event)
Возвращает k_ok и помещает событие в *event.
Если в очереди нет событий возвращает k_noevents.

### kcodes core_event_manager_init(void)
Подготавливает переменные модуля.
Возвращает k_ok.    

## Модуль задач
Заносит задачи в список выполнения, сортирует по приоритету.


## Модуль диспечера задач
Модуль обрабатывает возникшие в системе события и размещает их в очереди задач согласно их приоритету. При отсутвии союытий и задач для выполнения, модуль вызывает функцию ядра kcodes core_idle() 

### kcodes core_scheulder_loop(void)
Иницилизирует и запускает менеджер задач.
Выход из функции не предусмотрен.

Алгоритм работы диспетчера задач:
1. Иницилизация
2. Извлечение события
3. Поиск обработчика события
4. Добавление обработчиков в список
5. Если события не кончились то переходим к п.2
6. Если очередь пуста то вызываем core_idle() -> переход к п.2.
6. Сортировка списка по приоритету
7. Выполнение первого задания из списка (и его удаление из списка).
8. Переход п.2

## Модуль обработчиков событий
Модуль обработчиков событий возвращает указатель на список обработчиков и
их количество. Список обработчкиков содержит приоритет задачи. Списки компилируется статически. 
Для добавления новых событий или обработчиков требуется отредактировать
файл core_even_handler. В нем содержатся статические указатели.



### kcodes core_event_handlers(k_event event, core_task *tasks, uint16_t task_num)
Возвращает k_ok и указатель на список обработчиков и их количество.
Если подписчиков нет, то task_num = 0.
Если запрашиваемое событие не существует (>=EVENT_LASTEVENT_IN_ENUM)
то вызывается Kernel_panic

## Kernel panic

## kcodes core_idle()

## Атомарность операций

##  Ядро NEOS

